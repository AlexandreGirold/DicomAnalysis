const API_BASE_URL = window.location.origin;  // Use same origin as the page

let availableTests = {};
let currentTest = null;
let currentFormData = null;

const testList = document.getElementById('testList');
const testModal = document.getElementById('testModal');
const modalTitle = document.getElementById('modalTitle');
const modalDescription = document.getElementById('modalDescription');
const testForm = document.getElementById('testForm');
const formFields = document.getElementById('formFields');
const testResultsSection = document.getElementById('testResultsSection');
const loadingSection = document.getElementById('loadingSection');

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadAvailableTests();
    setupEventListeners();
});

function setupEventListeners() {
    // Test form submission
    testForm.addEventListener('submit', handleTestSubmission);
}

async function loadAvailableTests() {
    try {
        const response = await fetch(`${API_BASE_URL}/basic-tests`);
        if (!response.ok) {
            throw new Error('Failed to load tests');
        }
        
        const data = await response.json();
        availableTests = data.available_tests;
        displayTestList(availableTests);
        
    } catch (error) {
        console.error('Error loading tests:', error);
        testList.innerHTML = `
            <div class="error-message">
                <p>❌ Failed to load tests: ${error.message}</p>
                <button class="btn btn-primary" onclick="loadAvailableTests()">Retry</button>
            </div>
        `;
    }
}

function displayTestList(tests) {
    const testItems = Object.entries(tests).map(([testId, testInfo]) => `
        <div class="test-item" onclick="openTest('${testId}')">
            <span class="test-name">${testInfo.class_name.replace('Test', '')}</span>
            <span class="test-description">${testInfo.description}</span>
        </div>
    `).join('');
    
    testList.innerHTML = testItems;
}



async function openTest(testId) {
    try {
        currentTest = testId;
        
        // Show loading
        showLoading('Loading test form...');
        
        // Get test form data
        console.log(`Fetching form for test: ${testId}`);
        const response = await fetch(`${API_BASE_URL}/basic-tests/${testId}/form`);
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Form fetch failed:', response.status, errorText);
            throw new Error(`Failed to load test form: ${response.status} - ${errorText}`);
        }
        
        currentFormData = await response.json();
        console.log('Form data loaded:', currentFormData);
        hideLoading();
        
        // Populate modal
        modalTitle.textContent = currentFormData.title;
        modalDescription.textContent = currentFormData.description;
        
        // Build form fields
        buildFormFields(currentFormData.fields);
        
        // Show modal
        testModal.style.display = 'block';
        
    } catch (error) {
        hideLoading();
        console.error('Error opening test:', error);
        alert(`Failed to open test: ${error.message}`);
    }
}

function buildFormFields(fields) {
    formFields.innerHTML = fields.map(field => {
        switch (field.type) {
            case 'date':
                return `
                    <div class="form-group">
                        <label for="${field.name}">${field.label}</label>
                        <input type="date" id="${field.name}" name="${field.name}" 
                               ${field.required ? 'required' : ''} 
                               value="${field.default || ''}" 
                               class="form-input">
                    </div>
                `;
            case 'text':
                return `
                    <div class="form-group">
                        <label for="${field.name}">${field.label}</label>
                        <input type="text" id="${field.name}" name="${field.name}" 
                               ${field.required ? 'required' : ''} 
                               placeholder="${field.placeholder || ''}" 
                               class="form-input">
                    </div>
                `;
            case 'number':
                return `
                    <div class="form-group">
                        <label for="${field.name}">${field.label}</label>
                        <div class="input-with-unit">
                            <input type="number" id="${field.name}" name="${field.name}" 
                                   ${field.required ? 'required' : ''} 
                                   ${field.min !== undefined ? `min="${field.min}"` : ''}
                                   ${field.max !== undefined ? `max="${field.max}"` : ''}
                                   ${field.step !== undefined ? `step="${field.step}"` : ''}
                                   class="form-input">
                            ${field.unit ? `<span class="unit">${field.unit}</span>` : ''}
                        </div>
                    </div>
                `;
            case 'file':
                return `
                    <div class="form-group">
                        <label for="${field.name}">${field.label}</label>
                        <input type="file" id="${field.name}" name="${field.name}" 
                               ${field.required ? 'required' : ''} 
                               ${field.accept ? `accept="${field.accept}"` : ''}
                               ${field.multiple ? 'multiple' : ''}
                               class="form-input file-input">
                        ${field.description ? `<div class="field-description">${field.description}</div>` : ''}
                    </div>
                `;
            default:
                return '';
        }
    }).join('');
    
    // Add tolerance info if available
    if (currentFormData.tolerance) {
        formFields.innerHTML += `
            <div class="tolerance-info">
                <strong>Tolérance:</strong> ${currentFormData.tolerance}
            </div>
        `;
    }
}

async function handleTestSubmission(e) {
    e.preventDefault();
    
    try {
        // FIRST - capture the test ID before anything else
        const testId = currentTest;
        if (!testId) {
            throw new Error('No test selected. Please close this modal and select a test again.');
        }
        
        // Debug: Check currentFormData
        console.log('Current test:', testId);
        console.log('Current form data:', currentFormData);
        
        // Capture form data from DOM directly (more reliable)
        const capturedFormData = new FormData(testForm);
        
        // Log what we captured
        console.log('Captured form data entries:');
        for (let [key, value] of capturedFormData.entries()) {
            console.log(`${key}:`, value);
        }
        
        // Determine if this is a file upload test
        let isFileUploadTest = false;
        if (currentFormData && currentFormData.file_upload) {
            isFileUploadTest = true;
        } else if (testId === 'mlc_leaf_jaw') {
            // MLC test is always a file upload test
            isFileUploadTest = true;
        }
        
        console.log('Is file upload test:', isFileUploadTest);
        
        // Validate based on test type
        if (isFileUploadTest) {
            // Validate file upload
            const fileInput = document.querySelector('input[type="file"]');
            if (!fileInput || !fileInput.files.length) {
                throw new Error('Please select at least one file');
            }
            
            // Validate operator for MLC test
            const operatorValue = capturedFormData.get('operator');
            if (!operatorValue || !operatorValue.trim()) {
                throw new Error('Please enter operator name');
            }
        } else {
            // Validate regular test fields
            const operatorValue = capturedFormData.get('operator');
            if (!operatorValue || !operatorValue.trim()) {
                throw new Error('Please enter operator name');
            }
        }
        
        // Show loading and close modal AFTER we've captured everything
        showLoading('Executing test...');
        closeTestModal();
        
        if (isFileUploadTest) {
            // Handle file upload test (like MLC)
            await handleFileUploadTest(capturedFormData, testId);
        } else {
            // Handle regular test
            await handleRegularTest(capturedFormData, testId);
        }
        
    } catch (error) {
        hideLoading();
        console.error('Error executing test:', error);
        alert(`Test execution failed: ${error.message}`);
    }
}

async function handleRegularTest(capturedFormData, testId) {
    // Convert FormData to regular object for JSON submission
    const data = {};
    for (let [key, value] of capturedFormData.entries()) {
        // Check if this looks like a number field based on the input type
        const inputElement = document.querySelector(`input[name="${key}"]`);
        if (inputElement && inputElement.type === 'number') {
            data[key] = parseFloat(value);
        } else {
            data[key] = value;
        }
    }
    
    console.log('Submitting regular test data:', data);
    
    // Submit test
    const response = await fetch(`${API_BASE_URL}/basic-tests/${testId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    });
    
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Test execution failed');
    }
    
    const result = await response.json();
    hideLoading();
    
    // Display results
    displayTestResults(result);
}

async function handleFileUploadTest(capturedFormData, testId) {
    console.log('Submitting file upload test');
    console.log('FormData entries:');
    for (let [key, value] of capturedFormData.entries()) {
        console.log(`${key}:`, value);
    }
    
    // First try debug endpoint
    try {
        const debugResponse = await fetch(`${API_BASE_URL}/basic-tests/mlc-leaf-jaw-debug`, {
            method: 'POST',
            body: capturedFormData
        });
        const debugResult = await debugResponse.json();
        console.log('Debug result:', debugResult);
    } catch (debugError) {
        console.error('Debug request failed:', debugError);
    }
    
    // Submit test with files - use the specific MLC endpoint for file uploads
    const response = await fetch(`${API_BASE_URL}/basic-tests/mlc-leaf-jaw`, {
        method: 'POST',
        body: capturedFormData  // FormData handles multipart/form-data automatically
    });
    
    if (!response.ok) {
        const errorText = await response.text();
        console.error('Upload error:', errorText);
        throw new Error(`Upload failed: ${errorText}`);
    }
    
    const result = await response.json();
    hideLoading();
    
    // Display results
    displayTestResults(result);
}

function displayTestResults(result) {
    // Show results section
    testResultsSection.style.display = 'block';
    testResultsSection.scrollIntoView({ behavior: 'smooth' });
    
    // Update test name
    document.getElementById('resultTestName').textContent = result.test_name;
    
    // Update overall status
    const statusElement = document.getElementById('resultOverallStatus');
    statusElement.textContent = result.overall_result;
    statusElement.className = `overall-status ${result.overall_result.toLowerCase()}`;
    
    // Update results - compact single line format
    const resultsHtml = Object.entries(result.results).map(([name, res]) => `
        <div class="result-row ${res.status.toLowerCase()}">
            <span class="result-name">${name.replace(/_/g, ' ')}</span>
            <span class="result-value">${res.value} ${res.unit || ''}</span>
            <span class="result-status ${res.status.toLowerCase()}">${res.status}</span>
        </div>
    `).join('');
    document.getElementById('testResults').innerHTML = resultsHtml;
    
    // Display visualizations if available
    if (result.visualizations && result.visualizations.length > 0) {
        displayVisualizations(result.visualizations);
    } else {
        document.getElementById('testVisualizations').style.display = 'none';
    }
}

let currentVisualizationIndex = 0;
let allVisualizations = [];

function displayVisualizations(visualizations) {
    const visualizationsSection = document.getElementById('testVisualizations');
    const visualizationsList = document.getElementById('visualizationsList');
    
    if (!visualizations || visualizations.length === 0) {
        visualizationsSection.style.display = 'none';
        return;
    }
    
    visualizationsSection.style.display = 'block';
    allVisualizations = visualizations;
    currentVisualizationIndex = 0;
    
    // Display first visualization with navigation
    displayCurrentVisualization();
}

function displayCurrentVisualization() {
    const visualizationsList = document.getElementById('visualizationsList');
    const viz = allVisualizations[currentVisualizationIndex];
    
    const navControls = allVisualizations.length > 1 ? `
        <div class="visualization-nav">
            <button class="nav-btn" onclick="previousVisualization()" ${currentVisualizationIndex === 0 ? 'disabled' : ''}>
                ← Previous
            </button>
            <span class="nav-counter">${currentVisualizationIndex + 1} / ${allVisualizations.length}</span>
            <button class="nav-btn" onclick="nextVisualization()" ${currentVisualizationIndex === allVisualizations.length - 1 ? 'disabled' : ''}>
                Next →
            </button>
        </div>
    ` : '';
    
    // Display file-specific status if available
    const statsHtml = viz.statistics ? `
        <div class="file-status-bar">
            <span class="file-status-label">Test Result:</span>
            <span class="file-status-badge ${viz.statistics.status.toLowerCase()}">${viz.statistics.status}</span>
            <div class="blade-stats">
                <span class="blade-stat">Total: <strong>${viz.statistics.total_blades}</strong></span>
                <span class="blade-stat success">OK: <strong>${viz.statistics.ok_blades}</strong></span>
                <span class="blade-stat danger">Failed: <strong>${viz.statistics.out_of_tolerance}</strong></span>
                <span class="blade-stat info">Closed: <strong>${viz.statistics.closed_blades}</strong></span>
            </div>
        </div>
    ` : '';
    
    visualizationsList.innerHTML = `
        ${navControls}
        <div class="visualization-item">
            <h5>${viz.name}</h5>
            ${statsHtml}
            ${viz.type === 'image' ? 
                `<img src="${viz.data}" alt="${viz.name}" class="visualization-image" onclick="openImageModal('${viz.data}', '${viz.name}')">` :
                `<div class="visualization-data">${viz.data}</div>`
            }
        </div>
    `;
}

function nextVisualization() {
    if (currentVisualizationIndex < allVisualizations.length - 1) {
        currentVisualizationIndex++;
        displayCurrentVisualization();
    }
}

function previousVisualization() {
    if (currentVisualizationIndex > 0) {
        currentVisualizationIndex--;
        displayCurrentVisualization();
    }
}

function openImageModal(imageSrc, title) {
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.innerHTML = `
        <div class="image-modal-content">
            <div class="image-modal-header">
                <h3>${title}</h3>
                <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
            </div>
            <img src="${imageSrc}" alt="${title}" class="full-size-image">
        </div>
    `;
    
    modal.onclick = function(event) {
        if (event.target === modal) {
            modal.remove();
        }
    };
    
    document.body.appendChild(modal);
}

function closeTestModal() {
    testModal.style.display = 'none';
    currentTest = null;
    currentFormData = null;
}

function forceCloseTestModal() {
    // Force close even during form submission
    closeTestModal();
}

function newTest() {
    testResultsSection.style.display = 'none';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function printResults() {
    window.print();
}

function showLoading(message = 'Loading...') {
    loadingSection.querySelector('p').textContent = message;
    loadingSection.style.display = 'block';
}

function hideLoading() {
    loadingSection.style.display = 'none';
}

// Close modal when clicking outside - but with confirmation if form has data
window.onclick = function(event) {
    if (event.target === testModal) {
        // Check if form has any input
        const formElements = testModal.querySelectorAll('input, select, textarea');
        let hasData = false;
        
        for (let element of formElements) {
            if (element.type === 'file') {
                if (element.files && element.files.length > 0) {
                    hasData = true;
                    break;
                }
            } else if (element.value && element.value.trim()) {
                hasData = true;
                break;
            }
        }
        
        if (hasData) {
            if (confirm('You have entered data. Are you sure you want to close this form?')) {
                closeTestModal();
            }
        } else {
            closeTestModal();
        }
    }
}
